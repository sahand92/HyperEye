function s = NIR2HSI(spectra)

% input NIR spectra (of size N X 1050)
% output are spectra of size (N X 267), in the HSI range
% note: 12 channels are discarded at the right edge to match NIR and HSI
% ranges, and 10 channels are discared from the left edge.

bands_HSI=[958.59,964.26,969.94,975.61,981.28,986.95,992.62,998.29,1003.95,1009.62,1015.29,1020.95,1026.61,1032.27,1037.93,1043.59,1049.25,1054.91,1060.57,1066.22,1071.88,1077.53,1083.18,1088.84,1094.49,1100.14,1105.79,1111.43,1117.08,1122.73,1128.37,1134.02,1139.66,1145.3,1150.94,1156.59,1162.23,1167.86,1173.5,1179.14,1184.78,1190.41,1196.05,1201.68,1207.31,1212.94,1218.57,1224.2,1229.83,1235.46,1241.09,1246.72,1252.34,1257.97,1263.59,1269.22,1274.84,1280.46,1286.08,1291.71,1297.33,1302.94,1308.56,1314.18,1319.8,1325.41,1331.03,1336.64,1342.26,1347.87,1353.48,1359.1,1364.71,1370.32,1375.93,1381.54,1387.15,1392.75,1398.36,1403.97,1409.57,1415.18,1420.78,1426.39,1431.99,1437.59,1443.2,1448.8,1454.4,1460,1465.6,1471.2,1476.8,1482.4,1487.99,1493.59,1499.19,1504.78,1510.38,1515.97,1521.57,1527.16,1532.76,1538.35,1543.94,1549.53,1555.12,1560.72,1566.31,1571.9,1577.49,1583.07,1588.66,1594.25,1599.84,1605.43,1611.01,1616.6,1622.18,1627.77,1633.36,1638.94,1644.52,1650.11,1655.69,1661.27,1666.86,1672.44,1678.02,1683.6,1689.18,1694.77,1700.35,1705.93,1711.51,1717.09,1722.67,1728.24,1733.82,1739.4,1744.98,1750.56,1756.14,1761.71,1767.29,1772.87,1778.44,1784.02,1789.6,1795.17,1800.75,1806.32,1811.9,1817.47,1823.05,1828.62,1834.19,1839.77,1845.34,1850.92,1856.49,1862.06,1867.64,1873.21,1878.78,1884.35,1889.93,1895.5,1901.07,1906.64,1912.22,1917.79,1923.36,1928.93,1934.5,1940.07,1945.65,1951.22,1956.79,1962.36,1967.93,1973.5,1979.07,1984.64,1990.21,1995.79,2001.36,2006.93,2012.5,2018.07,2023.64,2029.21,2034.78,2040.35,2045.92,2051.49,2057.06,2062.64,2068.21,2073.78,2079.35,2084.92,2090.49,2096.06,2101.63,2107.21,2112.78,2118.35,2123.92,2129.49,2135.06,2140.64,2146.21,2151.78,2157.35,2162.93,2168.5,2174.07,2179.64,2185.22,2190.79,2196.36,2201.94,2207.51,2213.09,2218.66,2224.24,2229.81,2235.38,2240.96,2246.54,2252.11,2257.69,2263.26,2268.84,2274.42,2279.99,2285.57,2291.15,2296.73,2302.3,2307.88,2313.46,2319.04,2324.62,2330.2,2335.78,2341.36,2346.94,2352.52,2358.1,2363.68,2369.26,2374.85,2380.43,2386.01,2391.6,2397.18,2402.76,2408.35,2413.93,2419.52,2425.1,2430.69,2436.28,2441.86,2447.45,2453.04,2458.63,2464.22,2469.81,2475.4,2480.99,2486.58,2492.17,2497.76,2503.35,2508.94,2514.54,2520.13,2525.73,2531.32,2536.92,2542.51,2548.11,2553.7,2559.3,2564.9];
bands_NIR=(400:2:2498);

bands_HSI_in_NIR = bands_HSI(1:end-12);
%1120
bands_NIR_fine=(400:0.01:2498);

idx = zeros(1,length(bands_HSI_in_NIR));
for i=1:length(bands_HSI_in_NIR)
    idx(i)=find(abs(bands_HSI_in_NIR(i)-bands_NIR_fine) < 0.001);  
end

% extrapolate NIR spectra to finer resolution
NIR_fine =  interp1(bands_NIR.',spectra.',bands_NIR_fine,'linear','extrap').';
s=NIR_fine(:,idx);

% finally the 1st 30 channels are discarded (detector edge), which also
% includes the detector switch (discontinuity) in the XDS scanner.
s=s(:,30:end);

%match intensity of NIR Eyefoss XDS 4 scanner to Specim hyperspec
%using reference cell serial #20581
 ratio_HSI_to_NIR=[1.6035
    1.6101
    1.6175
    1.6190
    1.6223
    1.6230
    1.6274
    1.6328
    1.6361
    1.6363
    1.6376
    1.6388
    1.6367
    1.6380
    1.6381
    1.6390
    1.7234
    1.7243
    1.7245
    1.7225
    1.7213
    1.7188
    1.7155
    1.7172
    1.7176
    1.7154
    1.7123
    1.7103
    1.7078
    1.7071
    1.7056
    1.7052
    1.7062
    1.7060
    1.7046
    1.7050
    1.7056
    1.7055
    1.7042
    1.7073
    1.7054
    1.7054
    1.7027
    1.7013
    1.6992
    1.6966
    1.6929
    1.6914
    1.6893
    1.6870
    1.6845
    1.6833
    1.6781
    1.6771
    1.6739
    1.6730
    1.6698
    1.6681
    1.6630
    1.6603
    1.6556
    1.6536
    1.6504
    1.6503
    1.6478
    1.6452
    1.6419
    1.6391
    1.6352
    1.6329
    1.6267
    1.6224
    1.6168
    1.6114
    1.6066
    1.6029
    1.5968
    1.5924
    1.5876
    1.5850
    1.5805
    1.5789
    1.5758
    1.5737
    1.5701
    1.5689
    1.5665
    1.5665
    1.5649
    1.5657
    1.5637
    1.5661
    1.5663
    1.5691
    1.5684
    1.5716
    1.5705
    1.5718
    1.5696
    1.5708
    1.5689
    1.5715
    1.5706
    1.5735
    1.5745
    1.5772
    1.5765
    1.5806
    1.5806
    1.5840
    1.5851
    1.5892
    1.5886
    1.5914
    1.5908
    1.5922
    1.5892
    1.5883
    1.5830
    1.5785
    1.5731
    1.5715
    1.5709
    1.5738
    1.5731
    1.5729
    1.5685
    1.5680
    1.5689
    1.5775
    1.5872
    1.5968
    1.5989
    1.6008
    1.6007
    1.6047
    1.6089
    1.6133
    1.6125
    1.6126
    1.6122
    1.6146
    1.6161
    1.6197
    1.6220
    1.6258
    1.6276
    1.6326
    1.6347
    1.6366
    1.6345
    1.6322
    1.6273
    1.6232
    1.6180
    1.6085
    1.5928
    1.5748
    1.5548
    1.5356
    1.5184
    1.5016
    1.4860
    1.4738
    1.4639
    1.4594
    1.4568
    1.4564
    1.4575
    1.4614
    1.4638
    1.4682
    1.4693
    1.4728
    1.4767
    1.4816
    1.4837
    1.4871
    1.4876
    1.4886
    1.4865
    1.4818
    1.4744
    1.4654
    1.4558
    1.4476
    1.4389
    1.4341
    1.4328
    1.4354
    1.4364
    1.4386
    1.4392
    1.4399
    1.4376
    1.4357
    1.4318
    1.4288
    1.4250
    1.4206
    1.4159
    1.4141
    1.4117
    1.4095
    1.4088
    1.4101
    1.4123
    1.4163
    1.4197
    1.4247
    1.4298
    1.4369
    1.4422
    1.4484
    1.4532
    1.4562
    1.4596
    1.4627
    1.4628
    1.4599
    1.4520
    1.4410
    1.4293
    1.4167
    1.4046
    1.3937
    1.3849
    1.3772
    1.3708
    1.3656
    1.3597
    1.3532
    1.3489
    1.3526
    1.3545
    1.3575
    1.3563
    1.3532
    1.3470
    1.3439
    1.3452
    1.3486
    1.3510
    1.3522
    1.3534
    1.3538
    1.3530
    1.3513
    1.3506
    1.3498
    1.3473
    1.3442
    1.3399
    1.3364
    1.3317
    1.3272
    1.3206
    1.3142
    1.3077
    1.3017
    1.2961
    1.2931
    1.2902
    1.2876
    1.2868
    1.2840
    1.2822];

% fix the intensity
s=s.*ratio_HSI_to_NIR(21:end)';

end